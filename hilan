function triggerTouch(element, eventType) {
  const event = document.createEvent('Event');
  event.initEvent(eventType, false, true);
  if (!element[eventType]){
    return;
  }
  element[eventType]();
  element.dispatchEvent(event);
}

function clickWeekdays(weekdaysArray) {
    if (!Array.isArray(weekdaysArray)) return;
    const weekdays = weekdaysArray
        .filter(n => n >= 1 && n <= 7) // ignore invalid values like 0
        .map(n => n - 1);
    // Get all rows of the calendar (skip header rows)
    const calendar = document.getElementById('calendar_container');
    if (!calendar) return;

    const rows = Array.from(calendar.querySelectorAll('tr')).slice(2); // Skip headers

    rows.forEach(row => {
        const cells = row.querySelectorAll('td.cDIES, td.cHD, td.calendarAbcenseDay');
        cells.forEach((cell, index) => {
            const dayOfWeek = index; // index 0 is week selector, 1 = Sunday, ... 7 = Saturday
            if (weekdays.includes(dayOfWeek)) {
                cell.click();
            }
        });
    });
    const refreshButton = document.getElementById('ctl00_mp_RefreshSelectedDays');
    refreshButton.click();
}

function getTimeFromObj(timeObj) {
  if (!timeObj) return "09:00";

  // exactTime: string or number
  if (timeObj.exactTime !== undefined) {
    if (typeof timeObj.exactTime === "string") return timeObj.exactTime;
    if (typeof timeObj.exactTime === "number") {
      const hour = Math.floor(timeObj.exactTime);
      const minutes = Math.round((timeObj.exactTime - hour) * 60);
      return `${String(hour).padStart(2, "0")}:${String(minutes).padStart(2, "0")}`;
    }
  }

  // range: array of two values
  if (timeObj.range !== undefined && Array.isArray(timeObj.range)) {
    let [start, end] = timeObj.range;

    const startMins = typeof start === "number" ? start * 60 : parseTimeToMinutes(start);
    const endMins = typeof end === "number" ? end * 60 : parseTimeToMinutes(end);

    const randomMins = startMins + Math.floor(Math.random() * (endMins - startMins + 1));
    return minutesToHHMM(randomMins);
  }

  return "09:00";
}

// Helper functions
function parseTimeToMinutes(timeStr) {
  const [h, m] = timeStr.split(":").map(Number);
  return h * 60 + m;
}
function minutesToHHMM(totalMins) {
  const h = Math.floor(totalMins / 60);
  const m = totalMins % 60;
  return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
}

// Core function: generate random per row
function fillAttendance(startTimeObj, endTimeObj, symbolId = "0") {
  $("tr[id^='ctl00_mp_RG_Days_'][id*='_row_']").each(function () {
    const $row = $(this);

    // generate a new random for each row
    const startTime = getTimeFromObj(startTimeObj);
    const endTime = getTimeFromObj(endTimeObj);

    $row.find("td[id*='cellOf_ManualEntry_EmployeeReports_row'] input").val(startTime);
    const endTimeCell = $row.find("td[id*='_ManualExit_EmployeeReports_row_'] input");
    endTimeCell.val(endTime);
    if (endTimeCell[0]){
        triggerTouch(endTimeCell[0], 'focus');
        triggerTouch(endTimeCell[0], 'blur');
    }
  });
}

// Wrappers
function fillAttendanceOffice(startTimeObj, endTimeObj) {
  fillAttendance(startTimeObj, endTimeObj, "0");
}
function fillAttendanceHome(startTimeObj, endTimeObj) {
  fillAttendance(startTimeObj, endTimeObj, "7");
}
